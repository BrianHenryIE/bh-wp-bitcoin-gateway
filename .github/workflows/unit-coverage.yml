name: Code Coverage Report Comment

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches:
      - master

env:
  COVERAGE_PHP_VERSION: '8.4'

jobs:
  php-tests:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write

    strategy:
      matrix:
        php: [ '8.4', '8.5' ]

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Checkout GitHub Pages branch for code coverage report
        if: ${{ github.ref == 'refs/heads/master' }}
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: gh-pages
          path: gh-pages

      # https://github.blog/news-insights/bypassing-jekyll-on-github-pages/
      # https://docs.github.com/en/pages/setting-up-a-github-pages-site-with-jekyll/about-github-pages-and-jekyll
      - name: Disable Jekyll for GitHub Pages
        if: ${{ matrix.php == env.COVERAGE_PHP_VERSION && github.ref == 'refs/heads/master' }}
        run: |
          if [ ! -f "gh-pages/.nojekyll" ]; then
            touch gh-pages/.nojekyll
          fi

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          coverage: ${{ matrix.php == env.COVERAGE_PHP_VERSION && 'xdebug' || 'none' }}

      - name: Install sponge
        run: sudo apt-get install moreutils

      # TODO: merge master.

      - name: Install PHP dependencies
        run: composer install --verbose

      - name: Install JS dependencies
        run: npm install

      - name: Build JS
        run: npm run build

      - name: Start wp-env
        run: npx wp-env start --debug

      - name: Run tests without coverage
        if: ${{ matrix.php != env.COVERAGE_PHP_VERSION }}
        run: |
          vendor/bin/codecept run unit --debug
          vendor/bin/codecept run wpunit --debug

      - name: Run tests with coverage
        if: ${{ matrix.php == env.COVERAGE_PHP_VERSION }} # We only need the coverage once
        run: |
          XDEBUG_MODE=coverage vendor/bin/codecept run unit --coverage unit.cov --debug
          XDEBUG_MODE=coverage vendor/bin/codecept run wpunit --coverage wpunit.cov --debug

      # If this fails, let it fail hard (Claude keeps highlighting failing as a problem).
      - name: Merge code coverage
        if: ${{ matrix.php == env.COVERAGE_PHP_VERSION }}
        run: |
          vendor/bin/phpcov merge \
            --clover tests/_output/clover.xml \
            --php gh-pages/${{ github.sha }}/phpunit/coveragephp.cov \
            --html gh-pages/${{ github.sha }}/phpunit/ \
            tests/_output

      - name: Update root gh pages to redirect to commit for master
        if: ${{ (matrix.php == env.COVERAGE_PHP_VERSION ) && (github.ref == 'refs/heads/master') }}
        run: |
          echo '<script>window.location.href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.sha }}/phpunit/index.html";</script><a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.sha }}/phpunit/index.html">Coverage at ${{ github.sha }}</a>' > gh-pages/index.html

      - name: Commit code coverage to gh-pages
        if: ${{ matrix.php == env.COVERAGE_PHP_VERSION && github.ref == 'refs/heads/master' }}
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          repository: gh-pages
          branch: gh-pages
          commit_message: "ðŸ¤– Commit code coverage to gh-pages"

      - name: Update README badge
        if: ${{ matrix.php == env.COVERAGE_PHP_VERSION }}
        run: vendor/bin/php-coverage-badger tests/_output/clover.xml .github/coverage.svg PHPUnit

      - name: Copy badge for PR comment display
        if: ${{ matrix.php == env.COVERAGE_PHP_VERSION && github.ref != 'refs/heads/master' }}
        run: cp .github/coverage.svg gh-pages/${{ github.sha }}/phpunit/coverage.svg

      - name: Commit code coverage badge
        if: ${{ matrix.php == env.COVERAGE_PHP_VERSION }}
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ðŸ¤– Commit code coverage badge"
          file_pattern: .github/coverage.svg

      - name: Get changed files
        if: ${{ matrix.php == env.COVERAGE_PHP_VERSION }}
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          separator: ','
          files: '**/**.php'

      - name: Generate markdown report
        if: ${{ matrix.php == env.COVERAGE_PHP_VERSION }} # We only need it added once
        run: |
          vendor/bin/php-codecoverage-markdown \
            --input-file gh-pages/${{ github.sha }}/phpunit/coveragephp.cov \
            --covered-files=${{ steps.changed-files.outputs.all_changed_files }} \
            --base-url "https://github.com/${{ github.repository }}/blob/${{ github.sha }}/%s" \
            --output-file coverage-report.md

      - name: Add to the PR message
        if: ${{ matrix.php == env.COVERAGE_PHP_VERSION }}
        run: |
          echo "[![Code Coverage ](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.event.pull_request.head.sha }}/phpunit/coverage.svg)](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.event.pull_request.head.sha }}/phpunit/html/)" > coverage-comment-header.md
          echo "$(cat coverage-comment-header.md)" > coverage-comment.md
          echo "" >> coverage-comment.md # Add new line to coverage-comment.md
          echo "" >> coverage-comment.md # Add new line to coverage-comment.md
          echo "$(cat coverage-report.md)" >> coverage-comment.md

      - name: Comment on PR
        uses: mshick/add-pr-comment@v2
        if: ${{ matrix.php == env.COVERAGE_PHP_VERSION }} # We only need it added once
        with:
          message-id: coverage-report
          message-path: coverage-comment.md
        continue-on-error: true # When a PR is opened by a non-member, there are no write permissions (and no access to secrets), so this step will always fail.

      - name: Cleanup wp-env
        if: always()
        run: npx wp-env stop
